<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <link rel="stylesheet" href="style.css">
</head>

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

<h1>World Happiness!</h1>


<div style="margin-bottom: 30px; margin-left: 60px;">
    <button onclick="update('Generosity')">Generosity</button>
    <button onclick="update('Log GDP per capita')">Log GDP per capita</button>
    <button onclick="update('Social support')">Social Support</button>
    <button onclick="update('Perceptions of corruption')">Corruption</button>
    <button onclick="update('Freedom to make life choices')">Freedom to make life choices</button>
</div>

<!--
<div style="margin-bottom: 30px;">

    <label for="year">Choose a year:</label>

    <select name="year" id="year">
      <option value="2011">2011</option>
      <option value="2012">2012</option>
      <option value="2013">2013</option>
      <option value="2014">2014</option>
      <option value="2015">2015</option>
      <option value="2016">2016</option>
      <option value="2017">2017</option>
      <option value="2018">2018</option>
      <option value="2019">2019</option>
      <option value="2020">2020</option>
    </select>

</div>

-->


<div class="range" style="margin-left: 60px;">
    
    <input class="slider" type="range" min="2011" max="2020" step="1" id="yearSlider">
    
    <div class="sliderticks">
        <p>2011</p>
        <p>2012</p>
        <p>2013</p>
        <p>2014</p>
        <p>2015</p>
        <p>2016</p>
        <p>2017</p>
        <p>2018</p>
        <p>2019</p>
        <p>2020</p>
    </div>
    
    <!--
    <datalist id="tickmarks">
        <option value="2011" label="0%"></option>
        <option value="2012"></option>
        <option value="2013"></option>
        <option value="2014"></option>
        <option value="2015"></option>
        <option value="2016" label="50%"></option>
        <option value="2017"></option>
        <option value="2018"></option>
        <option value="2019"></option>
        <option value="2020" label="100%"></option>
    </datalist>
    -->
    
</div>


<!-- Create a div where the graph will take place -->

<div id="tooltip"></div>

<div id="my_dataviz"></div>

<svg width="460" height="400" id="example1"></svg>



<script>

    

  
var selectedYear = 2018
var selectedItem = 'Log GDP per capita'

// set the dimensions and margins of the graph
var margin = {top: 30, right: 30, bottom: 70, left: 60},
    width = 1024 - margin.left - margin.right,
    height = 720 - margin.top - margin.bottom;

// append the svg object to the body of the page
var svg = d3.select("#my_dataviz")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

// Initialize the X axis
var x = d3.scaleLinear()
  .range([ 0, width ]);
//   .padding(0.2);
var xAxis = svg.append("g")
  .attr("transform", "translate(0," + height + ")")

// Initialize the Y axis
var y = d3.scaleLinear()
  .range([ height, 0]);
var yAxis = svg.append("g")
  .attr("class", "myYaxis")

// Color scale: Based on Happiness Index
var color = d3.scaleOrdinal()
    .domain(["very-low", "low", "medium", "high", "very-high"])
    .range(["#243B81", "#62BCCC", "#F64F39", "#EE9323", "#FFFF00"])


// var yearDropdown = d3.select('#year');
// selectedYear = yearDropdown.property('value');
  
// // console.log(d3.select('#tickmarks').property('value'));
  
// yearDropdown.on("change", function (d) {
//       // recover the option that has been chosen
//       selectedYear = d3.select(this).property("value")
//       // run the updateChart function with this selected option
//       update(selectedItem)
// })
    
yearSlider = d3.select('#yearSlider');
selectedYear = yearSlider.property('value');
    
    
yearSlider.on("change", function (d) {
      // recover the option that has been chosen
      selectedYear = d3.select(this).property("value")
      // run the updateChart function with this selected option
      update(selectedItem)
})
    
// -1- Create a tooltip div that is hidden by default:
var tooltip = d3.select("#tooltip")
//       .append("div")
    .style("opacity", 0)
    .style("position", "absolute")
    .attr("class", "tooltip")
    .style("background-color", "white")
//     .style("border-color", "black")
    .style("border", "solid")
    .style("border-width", "1px")
    .style("border-radius", "5px")
    .style("padding", "10px")
    .style("color", "black")
//         .append("g")
//             .attr("transform",
//             "translate(" + margin.left + "," + margin.top + ")")

// -2- Create 3 functions to show / update (when mouse move but stay on same circle) / hide the tooltip
var showTooltip = function(d) {
  tooltip
    .transition()
    .duration(200)
  tooltip
    .style("opacity", 1)
    .html("Country: " + d['Country name'])
    .style("top", (event.pageY + 20)+"px")
    .style("left",(event.pageX + 20)+"px")
}
var moveTooltip = function(d) {
  tooltip
    .style("top", (event.pageY + 20)+"px")
    .style("left",(event.pageX + 20)+"px")
}
var hideTooltip = function(d) {
  tooltip
    .transition()
    .duration(200)
    .style("opacity", 0)

  u
  .style("stroke", "black")
}


// A function that create / update the plot for a given variable:
function update(selectedVar) {
  
  selectedItem = selectedVar;

  // Parse the Data
  d3.csv("world-happiness-report.csv", function(data) {
      
      data = data.filter(function(d) {
          if (d['year'] == selectedYear) {
              return true;
          } else {
              return false;
          }
      })
      
      
      maxIndex = d3.max(data, function(d) { return +d['Life Ladder']; } );
      console.log(maxIndex)
      
      happiestCountry = ""
      hx = 0
      hy = 0
      
      
      data.forEach(function(d){ 
            d['Log GDP per capita'] = +d['Log GDP per capita']; 
            d['Perceptions of corruption'] = +d['Perceptions of corruption'];
            d['Healthy life expectancy at birth'] = +d['Healthy life expectancy at birth'];
            d['Generosity'] = +d['Generosity'];
            d['year'] = +d['year'];
            d['Life Ladder'] = +d['Life Ladder'];
            if (maxIndex == d['Life Ladder']) {
                happiestCountry = d['Country name'];
                hx = d['Life Ladder']
                hy = d[selectedVar]
            }
          });

    console.log(happiestCountry)
      
    // X axis
    x.domain([d3.min(data, function(d) { return +d['Life Ladder'] }), d3.max(data, function(d) { return +d['Life Ladder'] }) ]);
    xAxis.transition().duration(1000).call(d3.axisBottom(x))

    // Add Y axis
    y.domain([d3.min(data, function(d) { return +d[selectedVar] }), d3.max(data, function(d) { return +d[selectedVar] }) ]);
    yAxis.transition().duration(1000).call(d3.axisLeft(y));

    
    // Features of the annotation
    const annotations = [
      {
        note: {
          label: "Here is the annotation label",
          title: happiestCountry
        },
        x: hx,
        y: hy,
        dy: 100,
        dx: 100
      }
    ]

    // Add annotation to the chart
    const makeAnnotations = d3.annotation()
      .annotations(annotations)
    
    
    
    
    
    // variable u: map data to existing dots
    var dots = svg.selectAll("circle")
      .data(data)

    // update dots
    dots
      .enter()
//       .filter(function (d) { return d['year'] == 2018 })
      .append("circle")
      .merge(dots)
      .transition()
      .duration(1000)
        .attr("cx", function(d) { return x(d['Life Ladder']); })
        .attr("cy", function(d) { return y(d[selectedVar]); })
        .attr("r", function (d) { 
          if (d['Life Ladder'] < 3.5) {return 3}
          else if (d['Life Ladder'] < 4.5) {return 4.5}
          else if (d['Life Ladder'] < 6) {return 6}
          else if (d['Life Ladder'] < 7) {return 7.5}
          else {return 9}
        })
        .style("fill", function (d) { 
          if (d['Life Ladder'] < 3.5) {return color("very-low")}
          else if (d['Life Ladder'] < 4.5) {return color("low")}
          else if (d['Life Ladder'] < 6) {return color("medium")}
          else if (d['Life Ladder'] < 7) {return color("high")}
          else if (d['Life Ladder'] < 10){return color("very-high")}
        })
       .style("stroke", "black")
    
      
    dots
        .on("mouseover", showTooltip )
        .on("mousemove", moveTooltip )
        .on("mouseleave", hideTooltip )

    
    svg
      .append("g")
      .call(makeAnnotations)
    
      
      
    
  })

}

// Initialize plot
update('Social support')

</script>
